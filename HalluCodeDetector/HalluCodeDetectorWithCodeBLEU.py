import json
import numpy as np
from utils.Similarity import codebleu_similarity

def Calculate_SimilarityScore(codes):
    scores = []
    for i in range(0, len(codes)):
        score = 0
        for j in range(0, len(codes)):
            if j == i:
                continue
            score += codebleu_similarity(codes[i], codes[j])/(len(codes)-1)
        scores.append(score)
    return scores

def build_similarity_matrix(codes):
    n = len(codes)
    sim_matrix = np.zeros((n, n))
    for i in range(n):
        for j in range(n):
            if i <= j:
                sim = codebleu_similarity(codes[i], codes[j])
                sim_matrix[i][j] = sim
                sim_matrix[j][i] = sim
    return sim_matrix

def getCodeBLEUScores(filepath, size_per_question):
    # In the following annotated section, humaneval_scores and mbpp_scores are our experimental results.

    # humaneval_scores = [0.9119960953023842, 0.3212287392794918, 0.7789881970636907, 1, 0.8009375423100173, 0.6619390910083648, 1, 1, 0.8645851552648134, 0.6261350237319467, 0.5416294468294882, 0.8625215051655428, 0.858454705599881, 0.9590545138105896, 0.9190121755541436, 0.6741738736759655, 0.5021840736889626, 1, 0.9377609779386766, 0.6626606914681741, 0.6266507710962416, 0.8402079817802515, 0.9250286969949102, 0.7518688046350865, 0.5910256516092116, 0.7577440828277882, 0.9564432482560321, 0.8613451216180741, 0.658113883008419, 1, 0.573588529015696, 0.7765053861138076, 0.48576293580531993, 0.750953711577116, 0.53834101382197, 0.41526696335203295, 1, 0.8767401826847702, 0.8744971065984692, 0.7597605899980301, 0.905556994320012, 0.4007398446771686, 1, 0.9126860605586241, 0.920419414267102, 1, 0.8902848265071585, 0.9101349604919349, 0.841760895121018, 0.7006684893384056, 0.9794783153014945, 0.7146946813220496, 0.875127764874372, 0.7184015263135328, 1, 0.5462745001429348, 0.8539154729362468, 0.8541556374971844, 0.9664315386391349, 0.6138706493559953, 0.15470020288782604, 0.8686170941403218, 1, 1, 0.5592756342326671, 0.5190196979766803, 1, 0.7359295248798075, 0.8911712892380063, 0.7141884518530615, 0.37230741553839886, 0.9432848104807052, 0.7627133791622608, 0.6721210837550777, 1, 0.7168803707884766, 0.6421886374629159, 0.4869809416090336, 1, 0.8844789079862315, 1, 0.7550515296560132, 0.9782606383051338, 0.31848592023796257, 0.6589441657192499, 0.8752346260215349, 0.6986934385899334, 0.9393113617223923, 0.6386928174990417, 0.8628546763193291, 0.6752079736858219, 0.7587219224251355, 0.48860924199492844, 0.5810783615362263, 0.706329186056906, 0.6267308398711382, 0.593459948994743, 1, 0.8393675834710113, 0.3429135098983722, 1, 0.37753867481708336, 0.719692048955274, 0.513076727100928, 1, 0.7368310293037337, 0.9011617728394157, 0.9263763982648836, 0.6025726631791888, 0.47687924985444957, 0.4264083026936716, 0.8116036753542236, 0.8712662376354371, 0.8004299667189291, 0.6702910494218072, 0.9315308464671648, 0.2510631712783259, 0.9435085221331423, 0.7229701468211769, 0.2451138584167118, 0.8928484073925482, 1, 0.5120156675754219, 0.755786087915329, 0.4932736679487702, 0.9476799881671982, 0.5619752883408874, 0.38775629975068243, 1, 0.5847020769901704, 0.1690700885921442, 1, 0.6321768278485272, 0.3218434150480465, 0.6805644234405992, 0.9718916702379505, 0.9209547926589876, 0.5151806558075854, 0.9496249324183406, 0.5866162250856949, 0.8489020869933088, 0.6031408088522885, 1, 0.9463236009960508, 0.656455580129752, 0.4695508887991193, 0.2639279739868947, 0.44604435527818226, 0.4361988879735288, 0.9097332660785169, 0.91215664986891, 0.8549064754445376, 0.3420565948131305, 0.8187372342192252, 0.8568645932993438, 0.7557789637617548, 0.4291178193851809, 0.7601349693485904, 0.6861360931284386, 0.8685116456085551, 0.7307321451670151, 0.982401207600194, 0.8307259598391772, 0.5902921455755414]
    # return humaneval_scores

    # mbpp_scores = [0.9529560358397511, 0.4656894123792195, 0.8058040846712108, 0.8420477588661501, 0.8001995048487018, 0.9379860321169688, 1, 0.728415593497835, 0.7515988094869038, 0.9857896189871511, 0.9825325769088413, 0.9672704268716722, 0.5049504680958538, 0.9234082938155126, 0.5641151415372844, 0.9673904226489516, 1, 1, 1, 0.9676995977187055, 1, 1, 1, 0.818843598454017, 0.9073875588597899, 0.8438230612007889, 1, 0.8281541903505065, 0.8030235481302916, 1, 0.7955248483481542, 0.9094512910936889, 0.9549620914447996, 1, 0.941269445237175, 0.8374700493792443, 1, 0.8676551938178136, 0.7458158931608437, 1, 1, 0.819834957440218, 1, 0.475340746067894, 0.9438666024505706, 0.8952158007422136, 0.7596344354430941, 0.3502357373110931, 0.8068499784144911, 0.7807932428250852, 1, 1, 1, 0.8425966507156231, 1, 0.7648718871971671, 0.7921747673922176, 0.7103800077516088, 0.7736713300914234, 0.862607086948675, 1, 1, 0.6783588013105608, 1, 1, 0.8310524805999191, 0.862015819988875, 1, 0.7397604245481847, 0.7045450560630182, 0.5007549926388639, 0.5672646537197534, 1, 0.9167327739168656, 0.9729076640817336, 0.6703626807564189, 0.8675254337850291, 0.9732058423404091, 1, 0.8828266737967685, 0.8830965531172104, 1, 0.8141799837545849, 0.9869368409983432, 0.9242440172889079, 1, 1, 1, 1, 0.8903125712529245, 0.9816253922701115, 0.835625195465433, 0.9278709455736036, 0.9159115952150925, 0.7247620886860533, 0.8919521736805106, 1, 1, 0.6348800285974889, 0.7067997377430044, 1, 0.8813204972336004, 0.978736805786532, 1, 0.8116218192014548, 0.9007824536800042, 0.6950447956333606, 0.582319394547623, 1, 0.5962408970586589, 1, 0.6767956176163401, 0.612878690213656, 0.9287956714319943, 1, 0.5507121570283817, 0.8475582866499729, 0.7505699360591493, 0.9837052074324822, 0.8651833047478817, 0.5390550100046483, 0.5220649882048028, 0.8602515461076805, 0.5240531999366783, 1, 0.6392956920828581, 0.8151933672305326, 0.836505656839667, 0.6892291660102196, 0.7732492853025528, 0.882720227143585, 1, 0.9477724701505379, 0.5533177201460513, 0.8585445813071397, 0.9000485672810993, 0.8449310316634655, 0.608621023785306, 0.5969956371413241, 0.5679338002052319, 1, 0.9887272957010993, 1, 0.9235969031262778, 0.9485483449789767, 0.9804130657983308, 0.3362710939920522, 0.7216033873173697, 0.7728763589172443, 1, 0.9288429752103873, 0.9429438933193772, 0.7296961204952103, 0.7953896084283867, 0.7560112133189857, 0.9325362650511666, 1, 0.6398813095279802, 0.740307097178281, 0.9205409740384403, 0.8906114344830738, 1, 0.6031217094346291, 0.8940684374611831, 1, 0.9561653361111522, 0.8887203990176018, 0.9517436502018126, 0.9197374563007028, 1, 0.7413859906281693, 0.8857088497656913, 0.39016429972966543, 1, 0.8211062855167357, 1, 0.9231048030329141, 0.8238909395105873, 0.6033249703452648, 0.776029107380886, 0.6814537979277608, 0.8919938274141344, 0.8588816674080997, 1, 0.8256054531837471, 0.7646334490990638, 0.8473317505948812, 0.6133573659491173, 0.44114205163473297, 0.3155736216939019, 1, 1, 0.8644220258826806, 0.8974878570462141, 0.9113301240778784, 0.9555716424812326, 1, 0.8683642839181858, 0.9713440312948423, 0.9859703328762115, 0.9700068658452214, 1, 0.9493750270105912, 1, 1, 1, 0.9798506250672963, 1, 0.9656405248327606, 0.9806450214743546, 0.8516216688551135, 1, 0.9350458250457248, 0.9544155016203844, 0.8761379317596714, 0.7438742849099944, 1, 0.6282570399740248, 0.8151028697682251, 0.895228042632906, 1, 0.9097260119517423, 0.9445984463174546, 0.920743567228089, 0.6113434361996593, 1, 1, 0.9725609636114396, 1, 1, 0.6567313230982292, 0.8986708663511175, 0.8787793653134862, 0.9289190668627756, 0.7033173051967103, 0.6189702005640196, 0.6310406524726508, 1, 0.8271461421803883, 0.6534155309527356, 1, 1, 0.6616470459005259, 0.7926081894348982, 0.8466508392536178, 0.7246999877553092, 0.9393421908863103, 0.8821427775219147, 0.8570742540371241, 1, 1, 0.47081161551941475, 1, 1, 0.959784021985614, 0.8664021451343952, 0.9008823157708457, 1, 0.707589494023188, 0.8310764836748034, 0.961456239175646, 0.8433303735808323, 1, 0.9765680491507027, 0.91326745113199, 0.8518206989406975, 0.7605663073790099, 0.75844368788695, 0.46595983811385466, 1, 0.9908780125453724, 1, 1, 0.6515962815630745, 0.6956905826445097, 1, 1, 0.9852228755936983, 0.9483056561786023, 1, 1, 0.9716958620413427, 0.9451180704295608, 0.9804868669596738, 0.9435035967552994, 0.6750519073571739, 0.4520247444107562, 0.9327213146118765, 1, 0.5590310490076065, 0.9816441152266369, 0.9009697462116313, 0.5988052108971464, 0.6042723333594633, 0.863262520332619, 1, 0.8698872127094817, 0.9759303737313401, 0.9467192552409172, 0.9029681647428498, 0.927139674737142, 1, 0.5281639821139279, 0.6667913501034606, 0.836821192665367, 0.838175092840674, 0.8040388568391612, 0.9685365589819799, 1, 1, 0.7821356055608641, 0.8388144680434086, 1, 0.7004584279773867, 0.9269045770708375, 0.9770589853939795, 1, 0.928263070860192, 0.8685867962039164, 0.7160988225695837, 0.7831552228251144, 1, 0.8686309005116034, 0.8341450288866818, 0.9595483924627706, 0.7884435573946025, 0.6781997521955483, 0.7956032454459854, 1, 0.9561955987346389, 0.9398480001212055, 0.9626175897408269, 1, 0.8103967221336015, 0.2750737486973167, 0.9006664178333859, 0.8190857095272921, 1, 0.6782411686643166, 0.901948605373945, 0.9694798983388195, 0.6815937241205436, 1, 0.843105350466754, 1, 0.883632246862786, 0.6194055323433377, 0.8826375574805525, 0.5414770422518466, 0.7327276143531323, 0.919992001375628, 1, 0.8451448718571534, 0.9750301691288339, 0.6016284504982574, 0.7134860267312155, 0.6238141991332952, 0.8266759031342796, 0.8647611938520914, 0.9682973744299668, 0.9077691871258433, 0.9754352904107986, 1, 1, 0.7940426340649436, 0.8907444611149422, 0.8877562890923087, 0.8260295709806338, 0.9461557804456828, 1, 0.9745542161343008, 1, 1, 0.8138590683678062, 0.9539556367215771, 0.6079455272821371, 0.950333208916693, 0.8401093584279848, 0.8653676581107121, 0.9731632320234365, 1, 0.41083815042218574, 0.8485958819491728, 1, 1, 0.8928960574487426, 0.964206636112543, 1, 1, 0.6708878885045485, 0.9714837121087823, 0.9838704018987614, 0.7352041344509846, 1, 0.7136837318568764, 0.8991111886897469, 0.9022713409618668, 0.9910034036573196, 0.9338810127395711, 0.9014178965971664, 0.532478945931465, 0.9739436043296508, 0.9554261855171784, 1, 1, 1, 0.6180131377347557, 0.819202164758262, 0.9565660503151661, 1, 0.9195760033205531, 0.956984123329224, 1, 0.9622522159739086, 0.901206994492838, 0.7720349707393048, 0.5322779447093782, 1, 0.7922305172727633, 0.9210925168311122, 0.7133791403917373, 0.5641825122296821, 0.9237909301973863, 0.9640355798104447, 1, 0.8793124040439175, 0.9409876347245703, 1, 1, 0.9911843956408344, 0.44854093582140475, 0.6747735025730239, 0.5313260698105279, 0.9838371922363631, 1, 0.572825367209676, 0.5828950988795493, 1, 0.7146194513534462, 0.5736168077466446, 1, 0.9336668464584044, 1, 0.5698121868832238, 1, 1, 0.9584813004566595, 0.9135001589151261, 0.8511457988565726, 1, 1, 0.764677391627936, 0.990788985579039, 0.9193732011803621, 0.9218367248581949, 0.9336313633237647, 0.8451056301872777, 0.620197475632728, 1, 1, 1, 0.9227357290417829, 0.7563148041830234, 1, 0.9861855740363319, 0.6166397984615766, 0.811705173950287, 0.6876372887114528, 0.961879165777235, 0.23034427956453774, 0.7326157955547952, 0.7806897080652182, 0.4453643363189486, 1, 1, 1, 1, 0.823908292160549, 1, 0.6170437234774054, 1, 0.7480599932748073, 1, 1, 0.8092648695663958, 0.9505778203803823, 1, 0.8100960391464931, 0.9282409672636949, 0.9528112542216278, 0.968459447873995, 0.6275860559301599, 0.650202591337719, 0.7972454101097712, 0.9334632012338888, 0.7914651928614328, 0.7344911061045978, 0.9274973918821046, 1, 1, 0.9419884246342553, 0.6067675001011619, 0.8718228093169493, 0.9079106585430279, 0.6296430924128764, 1, 1, 0.9111818490701105, 1, 0.7021655209289803, 0.7040919454105038, 0.828129446645385, 0.7836170090797289, 0.8004559488473195, 0.8498120001165516, 0.8350879031689626, 1, 0.7491407545577309, 0.908506910675648, 0.8881976589981877, 0.7485994881732687, 0.9837586191304668, 0.9354799158541376, 0.9659012194218226, 0.6008710311603889, 0.7697311855854916, 0.7806064389508527, 0.8784494637439771, 0.8210420851323701, 0.8632749442328038, 1, 0.8500464302084931, 1, 0.9658738163735927, 1, 1, 1, 1, 1, 0.8582926278086072, 0.9330516790899563, 1, 1, 1, 0.6440815874052889, 0.2895618331544839, 0.9686535447191005, 0.9672326799251296, 0.9333315236659256, 0.9461556103612054, 1, 0.9701995561214569, 1, 0.7561230826481606, 1, 0.8441301395595352, 0.6942368919414725, 0.9406091103714234, 0.98413086775117, 0.9329754449654619, 0.8101558631051664, 1, 0.6027706789037086, 1, 1, 1, 0.9631089238031676, 1, 1, 0.5964768331226744, 0.8770467874121081, 0.9209277000038009, 0.9054567667380622, 0.9704085882345317, 0.8229944155780258, 0.8271393115463331, 0.6888986876093881, 0.9706110571215207, 1, 0.891106664613208, 0.7869517278703939, 0.9394148651918768, 1, 0.8570524250265196, 0.6564428907203519, 0.6823191477107413, 1, 1, 0.7925438528776172, 0.5268182096243913, 0.9387932256219549, 0.6414414445564958, 1, 0.9291511772936771, 0.6029997883830465, 1, 0.8873937570715862, 0.9633971924667977, 1, 1, 0.8276560342778101, 1, 0.9095039755818606, 1, 0.9464161442560921, 0.860302160610702, 0.9869293524417337, 0.8830035241744822, 0.42105627001109275, 0.9792864726816957, 0.6453651128772211, 1, 0.12964624140586678, 1, 0.9752766443623397, 0.6782811775491, 0.7257991492735529, 0.7892129014704778, 0.8007768015653258, 0.7951068830978325, 1, 0.8797472009218136, 0.8528535091413441, 1, 1, 0.9800090251077123, 0.9377792720356996, 1, 0.9422953323135677, 0.7667479762988402, 0.7163809019792677, 0.6864070049051092, 1, 0.9518564352887051, 0.7889323385003887, 0.7222441805817448, 0.5853794215789933, 0.840550338387965, 0.7964329682817133, 0.6249590682700107, 1, 0.7957221641818572, 0.9452590379659351, 1, 1, 0.922686983618136, 0.9794939697111531, 1, 0.7479637346307355, 1, 1, 1, 1, 1, 0.9550513533495038, 0.6968152447880815, 1, 0.936253171447281, 0.7878561000523883, 0.42956158403780986, 0.9502583936476224, 1, 0.21452872641016993, 0.8674317520172601, 0.6933778235876558, 1, 1, 0.8807145561847107, 1, 0.9738468320167568, 0.5905918058244847, 1, 1, 0.983180003080915, 0.9714355945491198, 0.8727647308302522, 0.665942626334272, 1, 1, 0.8774454609916325, 0.6592996019236652, 1, 0.7713442911676128, 0.7705867630001351, 0.6789864236335678, 0.8022207049122188, 0.8640417759392833, 0.6661409922570709, 0.9849982446165734, 0.8551166425779877, 0.8838892493842135, 0.7799719835439868, 0.9741062631097097, 0.7470561162078464, 1, 0.8580486861328611, 1, 0.420886527135925, 0.6345082340750068, 0.9522423915502485, 0.7228995182520552, 0.7577217688296916, 1, 0.9528571110087658, 1, 0.3638094511604874, 0.4073671739949775, 1, 0.8465774365549961, 1, 0.6757617663545832, 1, 1, 0.845654174519273, 0.9347140426320772, 1, 0.9045168507523496, 1, 1, 0.523297991032208, 0.7515145939664387, 0.6890699601321352, 1, 0.9004535657053296, 0.961290042948709, 0.7994246513817201, 1, 0.9282064970960862, 1, 0.8298070779942024, 0.9138464574089729, 0.5439490927487403, 0.9898624303391628, 0.958151707423553, 0.376940247732376, 0.8718176674315272, 1, 0.6221119913209586, 0.7668371629238847, 0.49830147090468085, 0.8876725229474851, 0.5244946515219364, 0.6921059488726732, 0.7419570040026928, 0.6609497483198081, 0.9154943783253748, 0.9255888061562934, 0.8031978189195869, 1, 0.6053288569854834, 0.8027669122697696, 0.9471758101247807, 1, 0.9877007219901663, 0.8454840157374385, 1, 0.7585761899254233, 1, 0.6562095959514855, 0.9729284319538358, 0.7000020179813601, 1, 0.915037009023403, 1, 0.6730056822047177, 1, 1, 0.7212822553528173, 0.741831715512427, 0.7421334597767293, 0.9326137126688961, 1, 0.8235170655522326, 0.9589618528790655, 0.9642277024053405, 0.7674952050773111, 0.8995717570853272, 0.8527101039618148, 0.9277414917286564, 0.7653098025350419, 0.49199661072520334, 0.9352393773530636, 0.7749610632182903, 0.9962513767753807, 0.3754979554558216, 0.9691337079409021, 0.9076990689549012, 0.9445023545503068, 1, 1, 0.3847477002468181, 0.5248359463816242, 0.8858808322885265, 1, 0.8576085659394205, 1, 1, 1, 0.7565320004022198, 0.9503332089166929, 0.9931292345689802, 0.7342500904243123, 0.978225711982158, 0.5281049736678481, 0.7438630723254469, 1, 1, 0.8464755508093007, 1, 0.43135277781714765, 1, 0.9507924100245664, 1, 1, 1, 1, 0.9170734659213404, 1, 0.9576134239075322, 0.9312661936484747, 1, 0.5009907578248528, 1, 1, 1, 0.9974115962533494, 0.88816400037587, 0.9169931870641905, 0.9314280794167884, 0.6306769436837039, 0.8566948555134561, 0.8563046418651923, 0.7505699360591493, 0.8823826935677483, 1, 0.6226002637842541, 0.5416545349082132, 0.39742716095930264, 1, 0.9225172662680929, 1, 1, 0.6810993706010849, 0.9591942579121429, 0.987308312572418, 0.9859172284570271, 0.4291565192801811, 1, 0.5805619659063334, 0.9049219602510992, 0.8003273805571711, 1, 0.9302693271847806, 1, 1, 0.9689700640736072, 1, 1, 0.9482338728347128, 0.9707175568941131, 0.7959750285903495, 0.8766622490437224, 1, 1, 1, 0.7471432305586957, 0.9804078659028415, 0.8197532644713217, 0.8234328278050607, 0.9738862350752691, 0.910394838192677, 1, 1, 0.6165668613727082, 0.9155266742982646, 0.8194679983131044, 1, 0.3454589422864752, 0.9695172090766924, 0.9938085080490282, 1, 0.7964187086185965, 0.6345092066904506, 0.7959329554946497, 0.9281952783891347, 1, 0.8979136190839447, 0.8593472646810083, 1, 0.9611239687917359, 1, 0.47737952276651163, 1, 0.34175097525157677, 0.4890402335467379, 1, 0.8840423707360767, 0.3877792453272929, 0.8460730242618177, 0.36157176402251223, 0.9753223286992512, 0.7992190999662538, 0.7439141513636646, 0.7295546046694643, 0.8059777481431554, 1, 0.701566339515149, 1, 0.7518398495638929, 0.917268479675063, 0.6620538281636241, 0.5921471171680228, 0.9068567622334198, 0.9449411299360823, 0.9695387383026501, 0.893229884268681, 1, 0.8907292398376672, 0.8422043888537227, 1, 0.9549377319923913, 0.7636890508733551, 1, 1, 0.8586735231189142, 0.5924887299576631, 1, 0.5760860604917284, 0.903487300403625, 0.967674384472726, 1, 1, 0.6387961936927613, 0.8358279529361925, 0.9616700346746494, 0.41576032795541523, 0.6898402951280017, 0.7484242849570932, 0.5643401126743789, 0.9070752941719757, 0.8910277224827077, 0.78300747918429, 1, 0.5521690460499504, 1, 1, 0.7735951711187163, 0.8263858166239897, 0.872979931606205, 0.7972205846786851, 0.6946321555173728, 0.8930570975267673, 0.9831728137330482, 1, 0.9161157238526974, 1, 1, 1, 1, 0.9433860730406318, 0.9933667027611697, 1, 0.9760149605699602, 1, 0.8103267219455725, 1, 0.8178722196029566, 0.5235306081691031, 0.4555497778638749, 1, 0.9063360242317986, 1, 0.9101087184745016, 0.7194505193098683]
    # return mbpp_scores

    with open(filepath, 'r', encoding='utf-8') as file:
        data = json.load(file)

    y_score = []

    for question_id in range(0, int(len(data)/size_per_question)):
        codes = []
        for generation_index in range(0, size_per_question):
            codes.append(data[str(question_id * size_per_question + generation_index)]["generation_code"])

        score = 0
        for i in range(0, len(codes)):
            if i == 0:
                continue
            score += codebleu_similarity(codes[0], codes[i]) / (len(codes) - 1)

        if score >= 1:
            y_score.append(1)
        else:
            y_score.append(score)

        print(f"question_id: {question_id}")
        print(f"Score: {str(score)}")

    return y_score