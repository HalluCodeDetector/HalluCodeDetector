import json
import numpy as np
from utils.Similarity import bleu_similarity

def Calculate_SimilarityScore(codes):
    scores = []
    for i in range(0, len(codes)):
        score = 0
        for j in range(0, len(codes)):
            if j == i:
                continue
            score += bleu_similarity(codes[i], codes[j])/(len(codes)-1)
        scores.append(score)
    return scores

def build_similarity_matrix(codes):
    n = len(codes)
    sim_matrix = np.zeros((n, n))
    for i in range(n):
        for j in range(n):
            if i <= j:
                sim = bleu_similarity(codes[i], codes[j])
                sim_matrix[i][j] = sim
                sim_matrix[j][i] = sim
    return sim_matrix

def getBLEUScores(filepath, size_per_question):
    # In the following annotated section, humaneval_scores and mbpp_scores are our experimental results.

    # humaneval_scores = [0.9172959577608057, 0.23363845114585027, 0.7322823841704558, 1, 0.6323888782921429, 0.5220061513084212, 1, 1, 0.7968931779641268, 0.539292809940239, 0.3810195752156396, 0.7329803471820784, 0.7978128771916575, 0.9609635151423949, 0.9035210044070282, 0.48428767504013476, 0.24818539077695256, 1, 0.9542050350706559, 0.4377427479436895, 0.6026496542290988, 0.6843385334534254, 0.8550281933577626, 0.6670025193611004, 0.429772981998097, 0.6341043807951638, 0.914800934110841, 0.722690243236148, 0.31622776601683794, 1, 0.14287202148494, 0.6747529710269655, 0.3059514971732455, 0.668200176292525, 0.19620481234444498, 0.24551505153830916, 1, 0.7634285452843714, 0.7481449744069881, 0.8076120974069132, 0.7272649834766454, 0.35586662763615384, 1, 0.9172046410040211, 0.8701438258112806, 1, 0.8658884304310018, 0.7273795370621436, 0.6987897822147912, 0.6413752287517014, 0.9306122301705684, 0.5773271529015074, 0.8179237987101808, 0.5582821305967773, 1, 0.4783878607380797, 0.7372775484223082, 0.8470078356711502, 0.9568375619655671, 0.5847681736083801, 0.02539287146986957, 0.767222021251269, 1, 1, 0.41027786768190067, 0.28957894535863826, 1, 0.6082620491454981, 0.8614540335737275, 0.6525483202478782, 0.15773183459237144, 0.8779851059484104, 0.6878051592416646, 0.5928778180522157, 1, 0.6823151802912101, 0.49680460386294967, 0.3341872100281539, 1, 0.7513322045500284, 1, 0.5038721946121283, 0.9548569100518789, 0.18699686833429835, 0.5613785307100476, 0.7566816701767656, 0.52889031548311, 0.8750995445018166, 0.6893978964883962, 0.7296083890008198, 0.5476989736136689, 0.5968182121800516, 0.35410563174734716, 0.4444584682276917, 0.7506462813922647, 0.3686887991658815, 0.5113729879307107, 1, 0.8146740517423127, 0.16545603067259357, 1, 0.14691543772854002, 0.616893243451661, 0.46442414456978015, 1, 0.5950091404746775, 0.8680066181370178, 0.8874462405174333, 0.44194526536472495, 0.3550891044222998, 0.032148755649310114, 0.7407695278538939, 0.8300496695095876, 0.6721640250759977, 0.5205558192674901, 0.8733676999827982, 0.09497739480647273, 0.9254816312865652, 0.5506001080276608, 0.027518535393649266, 0.8281530042117737, 1, 0.26901552507988596, 0.7616129018936134, 0.47485005230288624, 0.8929827766481273, 0.40384157713441937, 0.3032003167492283, 1, 0.5034616592224721, 0.03524360156836477, 1, 0.47303128392014676, 0.18139145700404466, 0.3228554010770515, 0.942749251044368, 0.8356403802632827, 0.30373661982990796, 0.9506631285935778, 0.4107777171210865, 0.7502922233772578, 0.4701228209021797, 1, 0.9051490289483188, 0.33507021335345466, 0.35542479968476604, 0.013558201147574476, 0.470583343382703, 0.25754655662578757, 0.8056316226642143, 0.9426622570115386, 0.8634177175933828, 0.23120170449103025, 0.7800204842759495, 0.7987404547701115, 0.5357424192761289, 0.231965371156866, 0.5308861397990191, 0.6480902851075132, 0.8159567582135947, 0.6666802969551905, 0.9676514120820832, 0.7820214418244871, 0.5721740458730858]
    # return humaneval_scores

    # mbpp_scores = [0.9647618494524062, 0.3152750929652786, 0.6959168644443097, 0.7032484941507118, 0.7964255823395281, 0.8736276237259208, 1, 0.4256832592962793, 0.5975219578068084, 0.9864653315323015, 0.9563184032249203, 0.9294031762437387, 0.32723914163867357, 0.8951528447947326, 0.5147449876203042, 0.9334401067948335, 1, 1, 1, 0.9330986716616549, 1, 1, 1, 0.8164800392871809, 0.8733435850950428, 0.8243333429522065, 1, 0.8374642518603055, 0.7920326081282296, 1, 0.7145382424623195, 0.8486148531009545, 0.9268847437960812, 1, 0.8761888920598107, 0.7740968436573747, 1, 0.7299594310114399, 0.5763652153274778, 1, 1, 0.8229665812359324, 1, 0.42837121187369354, 0.9155677575391752, 0.7897174436869283, 0.7139530611420246, 0.24663473247563522, 0.6316617369304568, 0.6261224829287004, 1, 1, 1, 0.7929576447619446, 1, 0.5515949108039827, 0.5781173145642947, 0.41840447658538044, 0.5414688633808534, 0.8481010128232638, 1, 1, 0.6363468354043841, 1, 1, 0.7487815983308079, 0.7127984782843833, 1, 0.7382251726290059, 0.6196061298072519, 0.41362000555730005, 0.4777657936683563, 1, 0.8947738684349746, 0.9445935870246847, 0.5680033058667009, 0.7986792862675456, 0.9521683299497501, 1, 0.8249616999239713, 0.8747314095454454, 1, 0.63350873026743, 0.9850883015385452, 0.8430677301572889, 1, 1, 1, 1, 0.8479412402737554, 0.9622925404003069, 0.8075004316932001, 0.8931212188294921, 0.8300115646821324, 0.7527775889102644, 0.8867004461729775, 1, 1, 0.6545769436039103, 0.6434489742186879, 1, 0.8467659515790615, 0.9676171891069902, 1, 0.8447636361431254, 0.8009900505127121, 0.5187194202086318, 0.31097981401875857, 1, 0.4873695733592531, 1, 0.6734240205062287, 0.4931842549926784, 0.8897476834810991, 1, 0.2970871981825447, 0.767648850736204, 0.49752459956690925, 0.966807418921959, 0.7242123070567799, 0.4957465881082243, 0.438751042391342, 0.8732717765058468, 0.24438254720860486, 1, 0.5824582189605307, 0.8028843219901187, 0.6665865240112947, 0.6294871704643846, 0.7811228084834335, 0.8575029889235661, 1, 0.8945293286410738, 0.4705381360774437, 0.7134180396130334, 0.8243326547536609, 0.6863153648051721, 0.5877489484915195, 0.49436666887540326, 0.4547777817949956, 1, 0.9770839911669411, 1, 0.8437205379904482, 0.9759660908140293, 0.9594388349139849, 0.1923865176317986, 0.6275422433092586, 0.7295236292357483, 1, 0.8972391124737191, 0.8834163401019686, 0.5823043311837035, 0.6188103259812636, 0.49055880466248825, 0.8619686456717237, 1, 0.5295216073375454, 0.5453599899716818, 0.9127603925874992, 0.7788310814110051, 1, 0.5519654337382938, 0.8944329227543286, 1, 0.910068647409914, 0.859524166956314, 0.9028603714409216, 0.8990889051866886, 1, 0.4780790138739179, 0.7815369606865192, 0.2039602020508479, 1, 0.75382444749913, 1, 0.8758471848607912, 0.6882484377504128, 0.48375828231782647, 0.6824090371663173, 0.6336348233015553, 0.7828443753845125, 0.7833990832733131, 1, 0.765536594377103, 0.5587450863876214, 0.7185018811220966, 0.6068452554172782, 0.31767586984822027, 0.18235162462493404, 1, 1, 0.7850213844814677, 0.8462697892999471, 0.9149184879148633, 0.90940073493385, 1, 0.8714278170317964, 0.9410830157240567, 0.971301001389359, 0.9389406969220373, 1, 0.8978436402958871, 1, 1, 1, 0.9511247812512351, 1, 0.9368966788210649, 0.960384320462307, 0.7846091741294823, 1, 0.8993106679534264, 0.9241137015391494, 0.7492369481029082, 0.6390608729577949, 1, 0.5528191304498069, 0.6529434044756863, 0.8383818415963402, 1, 0.8754507863706233, 0.9336788554541029, 0.9206091361111388, 0.49008040604628506, 1, 1, 0.966845739584558, 1, 1, 0.6058311296138462, 0.8124950763660371, 0.7973914730971801, 0.9135889309499724, 0.3848474311997831, 0.4196344602685874, 0.5299410420653711, 1, 0.7918032121374982, 0.32177492369808786, 1, 1, 0.5914813577818921, 0.7410454801912055, 0.7741351449139469, 0.7235061064509845, 0.8962172435594962, 0.9326343938485471, 0.7815511526995769, 1, 1, 0.40701351095303623, 1, 1, 0.9277656641836158, 0.7812546442856556, 0.8906961662565811, 1, 0.7463805560883858, 0.7337269942187186, 0.9219800199595451, 0.6933852113335213, 1, 0.9523031812951404, 0.9028871248609166, 0.8496020940094687, 0.7026480295312896, 0.7037553769691014, 0.2716466139137507, 1, 0.977194946495062, 1, 1, 0.583348704480257, 0.6784570118023181, 1, 1, 0.9697424133593566, 0.93954431555562, 1, 1, 0.9427141470884874, 0.9482042230781076, 0.9601540584331298, 0.8960777204935344, 0.7034784380880571, 0.3771647345101343, 0.9124121689616027, 1, 0.31121705736841315, 0.9746657305072284, 0.8791800381183718, 0.442452756255982, 0.5655821369000191, 0.7199991976856086, 1, 0.7362320192827051, 0.9507587357579823, 0.8909057679203716, 0.9365057469143465, 0.9397941080503458, 1, 0.4477587602156459, 0.5767025983279943, 0.8435246581917972, 0.7113285694966576, 0.8456647710352139, 0.9297017914834742, 1, 1, 0.8018805193106125, 0.7166300482096537, 1, 0.5632431584110634, 0.9134188924065887, 0.9605162887756109, 1, 0.9217485222685553, 0.7351889361500865, 0.6753639979330472, 0.7361474203124599, 1, 0.8127366017429697, 0.6666251547750238, 0.9568687454902929, 0.7392242210068798, 0.5980633486469749, 0.625538925380849, 1, 0.9117296453833623, 0.8778130311960137, 0.9242453853778644, 1, 0.7506831076865765, 0.07809645396620687, 0.8005931132462298, 0.7596725436285987, 1, 0.5249529875113851, 0.8635274324549198, 0.9273023094046602, 0.5099206127650723, 1, 0.6973167778247338, 1, 0.779935565564471, 0.4311486696671167, 0.8447381374688352, 0.2743687035631755, 0.6221392264630956, 0.875300192391234, 1, 0.648235280989401, 0.9494718791070098, 0.6255798942481466, 0.4232340790633578, 0.5292202833194575, 0.8328732169825621, 0.8671519802751491, 0.9326110662470126, 0.814645304476044, 0.9646010807866705, 1, 1, 0.7778813511455842, 0.757997636988816, 0.829058344645713, 0.7661581965336608, 0.8901408946054443, 1, 0.9693516492216214, 1, 1, 0.7890601440579275, 0.9189239055344212, 0.498837613949494, 0.900296556623115, 0.8563873029690201, 0.7237987915118953, 0.9448768942806627, 1, 0.2552342271448685, 0.6659439112310166, 1, 1, 0.9004147055456513, 0.9138681580869226, 1, 1, 0.33499781859043437, 0.9579356812943953, 0.9800177688042504, 0.5328684056236435, 1, 0.6803512322617602, 0.8597727159441646, 0.8925527241421289, 0.981639594542959, 0.9264648504015656, 0.7994128356923735, 0.48408507753605956, 0.9700177587509489, 0.8644416205509675, 1, 1, 1, 0.4897906245163931, 0.7990552570868457, 0.9106247616218459, 1, 0.8981761158473978, 0.9130821604749721, 1, 0.9234875423119453, 0.9167089072295957, 0.6677853663412747, 0.31027571548955046, 1, 0.6074129583737368, 0.8321773906849228, 0.6728256201401739, 0.577675926169038, 0.8849250040526752, 0.9248010470047344, 1, 0.7560310851364573, 0.9241281718482908, 1, 1, 0.9821591898192594, 0.21619992681106348, 0.6681658167395462, 0.5218192744480901, 0.9608382825143478, 1, 0.5296473986929587, 0.3644101414040212, 1, 0.6327128743244078, 0.3730758692150623, 1, 0.86443556816969, 1, 0.5067406981257042, 1, 1, 0.8971744368692824, 0.8625545969547119, 0.7377635448679747, 1, 1, 0.6907320208659579, 0.9811781535808688, 0.8850426986570208, 0.9285147245138814, 0.8747655565931483, 0.7812614503382117, 0.5236096437928711, 1, 1, 1, 0.842082600130619, 0.7032031629713487, 1, 0.9715970354791168, 0.3886711981415131, 0.6191117308626521, 0.5415199604935861, 0.9514459886121812, 0.043032225915459694, 0.7527087256273752, 0.797183406126764, 0.2998653075756741, 1, 1, 1, 1, 0.7877942071620483, 1, 0.583584247792784, 1, 0.5125600261533643, 1, 1, 0.7624531389321109, 0.9156941805311822, 1, 0.7881158019076173, 0.9053450182315974, 0.9477822781313983, 0.9411073656975353, 0.3870531080548799, 0.5931748506414867, 0.6962104686737205, 0.8648678525004536, 0.7343726778272406, 0.6339287323072391, 0.8913015687521577, 1, 1, 0.9400671352356186, 0.5059147752821073, 0.828756421333686, 0.8946680724270182, 0.5064468912212967, 1, 1, 0.861415110401837, 1, 0.6453458504557741, 0.743518904978185, 0.7712520147867998, 0.5677072613742423, 0.5980196796535274, 0.7923613307809045, 0.7387202317648485, 1, 0.6793719192632823, 0.8288013547370181, 0.8569709892877293, 0.6720634510072437, 0.9666728332611627, 0.9346737811421828, 0.9473195873757783, 0.5118341289009382, 0.76342832303016, 0.7432596308909789, 0.7804639897513357, 0.8313452042548721, 0.7823886512439598, 1, 0.6983463938796808, 1, 0.9309234876563564, 1, 1, 1, 1, 1, 0.903147543636339, 0.9482197749991728, 1, 1, 1, 0.42248192040040244, 0.1505522161376114, 0.9515162861063373, 0.9687647282530343, 0.8622154890155755, 0.9320002754569774, 1, 0.9274488244546795, 1, 0.7986880552916764, 1, 0.7367817078050203, 0.4739088898738668, 0.9000916977257913, 0.9838801709622285, 0.898070114646903, 0.6161511311670496, 1, 0.1989235293267086, 1, 1, 1, 0.9620660345001959, 1, 1, 0.5238101389553285, 0.8055451338228045, 0.8676639361568328, 0.874301721523763, 0.9399435469068012, 0.8536701577186901, 0.6446157897862081, 0.5646310407285796, 0.9824555601664631, 1, 0.807327893349818, 0.6066113494380418, 0.9130791800266518, 1, 0.7017426593738859, 0.6157270757225779, 0.5845897824327388, 1, 1, 0.7059972500476198, 0.3808077268178237, 0.891085049097039, 0.48661548955549183, 1, 0.9233136197655647, 0.49479345508774025, 1, 0.8867204726779874, 0.9256159704340088, 1, 1, 0.6920293298587037, 1, 0.8489509826491779, 1, 0.9331932251648887, 0.8491701616012272, 0.9819093064040618, 0.723558817011017, 0.3392685794256859, 0.9809164170147895, 0.4843951555030031, 1, 0.01899784415473155, 1, 0.9493908760682157, 0.4416765980766616, 0.543004512662867, 0.575378823489946, 0.5963665570620293, 0.6437733416162755, 1, 0.840384963186187, 0.8544098723989626, 1, 1, 0.9820640754341807, 0.872512938805969, 1, 0.932549014789238, 0.6402856070143204, 0.42268703126954493, 0.5773818331641242, 1, 0.9018057157249064, 0.6121444274299931, 0.5105344453871814, 0.16776349097908383, 0.7514377812596256, 0.7213360395491851, 0.5271950370948647, 1, 0.6996590577682815, 0.9117515040436699, 1, 1, 0.8484946071292128, 0.971729125738019, 1, 0.6785137760253179, 1, 1, 1, 1, 1, 0.9368522234094696, 0.5856179780470546, 1, 0.9384034939149913, 0.7279455359632552, 0.2521885733506517, 0.9135747627543164, 1, 0.07602241374551591, 0.8215884687580164, 0.6578192918405982, 1, 1, 0.7604117682902539, 1, 0.9559681146003249, 0.4363657290379189, 1, 1, 0.9598137813991103, 0.9421602798270035, 0.7437324743193798, 0.5115239615333773, 1, 1, 0.8154804141283463, 0.5060580465075161, 1, 0.6712371199229248, 0.37943986022135645, 0.6101933377795901, 0.6005195863569741, 0.8701502507936236, 0.32710642557391745, 0.9694798116604016, 0.7761435268670659, 0.8796477014154241, 0.6401989414088537, 0.9472646643205369, 0.4950657667110078, 1, 0.8323680475714328, 1, 0.3460658507588707, 0.4994094021390082, 0.9028917286032982, 0.6872626377233302, 0.7916775659481452, 1, 0.9730537575394187, 1, 0.19462025729042057, 0.3312808599109097, 1, 0.7982749689964518, 1, 0.6714252840742038, 1, 1, 0.7806331944587744, 0.9267245643761697, 1, 0.8790516157623003, 1, 1, 0.043472087194499145, 0.7499250153482959, 0.5340597045228908, 1, 0.9067753732814265, 0.9207686409246139, 0.7581772622224794, 1, 0.8728526641822343, 1, 0.8398836606710867, 0.8240659932369194, 0.3561279268175547, 0.9794737148568073, 0.9144084924391396, 0.3411182932308992, 0.7788023484078923, 1, 0.6402529012752797, 0.7745788384649264, 0.4404043505280131, 0.9326343938485468, 0.29277648933886, 0.6662998672038933, 0.4780790138739179, 0.5358163466092297, 0.9074206168203334, 0.9129301090394301, 0.5984622032438248, 1, 0.20556680845025985, 0.7043887465411557, 0.9311927681513512, 1, 0.9749913858143302, 0.8994884423840458, 1, 0.5337461237749347, 1, 0.5689894532717507, 0.9871540658321873, 0.6341832214829989, 1, 0.8595985260812691, 1, 0.5154773963042811, 1, 1, 0.6114120965832606, 0.560306048013356, 0.5242343162827153, 0.8910780226836343, 1, 0.6851115809035166, 0.9161581150579878, 0.9259370407684742, 0.7137309339880703, 0.7892292985050431, 0.7121323835619939, 0.8528734121992454, 0.6236427074866313, 0.40714202295690316, 0.9079918809214964, 0.7413040184659879, 0.9922337922126732, 0.06612173992743471, 0.9374039849059743, 0.8616944342060988, 0.937191207993888, 1, 1, 0.2722942838790355, 0.08602262035915358, 0.7961557474063126, 1, 0.7574252282868281, 1, 1, 1, 0.673664109086785, 0.9002965566231149, 0.9862584691379601, 0.7275200752491441, 0.9556109083577504, 0.365579654555608, 0.6004473906871659, 1, 1, 0.6859560399694397, 1, 0.25817855716400456, 1, 0.9004151916596863, 1, 1, 1, 1, 0.8895358254601429, 1, 0.922990459213987, 0.8955122158591868, 1, 0.46238591864160156, 1, 1, 1, 0.9948231925066986, 0.7322289245720544, 0.8313429266804186, 0.9364956522944182, 0.6684860891615376, 0.7730075397181393, 0.756591341539155, 0.4975245995669092, 0.941669885844122, 1, 0.5065591467390009, 0.3719990273518695, 0.16448465954461575, 1, 0.8873154404246, 1, 1, 0.5457169900073137, 0.9533809452009316, 0.9677179110851959, 0.9863272105372427, 0.24440643865020267, 1, 0.5502418096721531, 0.8640750200030183, 0.7906162587468264, 1, 0.9254925263134983, 1, 1, 0.9363616982044072, 1, 1, 0.9105564224765541, 0.9406615379465553, 0.7690686395710322, 0.8224915571523248, 1, 1, 1, 0.5096397169630761, 0.9602525310880825, 0.8527160667152588, 0.7360899609909722, 0.9472646643205369, 0.8191229673172407, 1, 1, 0.5201434935024335, 0.8396648964870657, 0.7862954495994525, 1, 0.16000318413870862, 0.9491531426413147, 0.9869020056722896, 1, 0.6068681492333831, 0.6656406440339774, 0.7525982599869959, 0.8932341636181647, 1, 0.7869166222114135, 0.7100846819233138, 1, 0.9535845441572952, 1, 0.31789503709915684, 1, 0.22345703344230128, 0.4538836363717592, 1, 0.8183498190744569, 0.25607936100539, 0.7899982581992446, 0.29420770793429696, 0.9692919738888699, 0.7235957888266025, 0.5523250238871195, 0.5948903654186938, 0.5263448690917335, 1, 0.5993437286580712, 1, 0.7579247789270056, 0.8724036558579162, 0.6206294202081957, 0.5256398492677152, 0.8090956687987447, 0.9076587448904121, 0.9380993511609739, 0.8233803460029089, 1, 0.9036789050211367, 0.7468160854373664, 1, 0.9079243561650978, 0.765482384763147, 1, 1, 0.7120767771862188, 0.4257716041840802, 1, 0.4921561036555897, 0.8057207428818429, 0.9216765650286953, 1, 1, 0.28488986226235774, 0.6696852693403277, 0.9214440209654089, 0.28993681733243937, 0.6304711672475529, 0.6946472744055856, 0.36089810090579927, 0.8635115591877107, 0.7781857125297371, 0.5830700295314017, 1, 0.31742506429122397, 1, 1, 0.5344445934790545, 0.6940865489998884, 0.7774613729080404, 0.67202067970564, 0.5147786854519741, 0.8610873015175262, 0.9752752250303074, 1, 0.9485993610358233, 1, 1, 1, 1, 0.9020858704000303, 0.9881568962898981, 1, 0.9394282761865973, 1, 0.7573453453930008, 1, 0.7551765417772311, 0.4535399515882495, 0.3021557320900784, 1, 0.9142300908738399, 1, 0.841602020218126, 0.7104257636203661]
    # return mbpp_scores

    with open(filepath, 'r', encoding='utf-8') as file:
        data = json.load(file)

    y_score = []

    for question_id in range(0, int(len(data)/size_per_question)):
        codes = []
        for generation_index in range(0, size_per_question):
            codes.append(data[str(question_id * size_per_question + generation_index)]["generation_code"])

        score = 0
        for i in range(0, len(codes)):
            if i == 0:
                continue
            score += bleu_similarity(codes[0], codes[i]) / (len(codes) - 1)

        if score >= 1:
            y_score.append(1)
        else:
            y_score.append(score)

        print(f"question_id: {question_id}")
        print(f"Score: {str(score)}")

    return y_score