import json
import numpy as np
import matplotlib.pyplot as plt
from sklearn.metrics import roc_curve, auc
from utils.Similarity import bleu_similarity
from sklearn import metrics
from openai import OpenAI
from concurrent.futures import ThreadPoolExecutor

def generate_one_completion(prompt, client, model):
    completion = client.chat.completions.create(
        model=model,
        stream=True,
        messages=[
            {"role": "user", "content": prompt}
        ]
    )
    full_response = ""
    for chunk in completion:
        if chunk.choices[0].delta and chunk.choices[0].delta.content:
            full_response += chunk.choices[0].delta.content
    return full_response

def process_comparison(i, codes, api_key, base_url, model):
    prompt = f"""Sample1:\n{codes[0]}\n\nSample2:\n{codes[i]}\n\nAre the samples functionally consistent?\nJust answer "yes" or "no":"""
    client = OpenAI(api_key=api_key, base_url=base_url)
    try:
        ans = generate_one_completion(prompt, client, model)
        if ans == "Yes" or ans == "yes" or ans == "YES":
            return 1.0 / (len(codes) - 1)
        elif ans == "No" or ans == "no" or ans == "NO":
            return 0.0
        else:
            return 0.5 / (len(codes) - 1)
    except Exception as e:
        return 0.5 / (len(codes) - 1)

def getPromptScores(filepath, size_per_question, base_url, api_key, model):
    # In the following annotated section, humaneval_scores and mbpp_scores are our experimental results.

    # humaneval_scores = [1, 0.1111111111111111, 1, 1, 0.3333333333333333, 1, 1, 1, 0, 0.6666666666666667, 1, 0.5555555555555556, 1, 0.6666666666666667, 1, 1, 1, 1, 0.7777777777777779, 1, 0.2222222222222222, 0.8888888888888891, 1, 1, 0.2222222222222222, 1, 1, 1, 1, 1, 1, 1, 0.2222222222222222, 1, 1, 0.1111111111111111, 1, 1, 1, 0.5555555555555556, 0.7777777777777779, 0, 1, 1, 0.8888888888888891, 1, 1, 1, 0.8888888888888891, 0.8888888888888891, 0.8888888888888891, 1, 1, 0, 1, 0.4444444444444444, 0.8888888888888891, 0.5555555555555556, 1, 1, 1, 1, 1, 1, 0.8888888888888891, 0.1111111111111111, 1, 0.3333333333333333, 0.6666666666666667, 1, 0.8888888888888891, 1, 1, 1, 1, 0.3333333333333333, 0.3333333333333333, 0.6666666666666667, 1, 1, 1, 1, 0.6666666666666667, 0, 1, 1, 1, 1, 0.4444444444444444, 0.8888888888888891, 1, 0.3333333333333333, 0.5555555555555556, 0.2222222222222222, 0.8888888888888891, 0.3333333333333333, 1, 1, 0.8888888888888891, 0.2222222222222222, 0.5555555555555556, 0.4444444444444444, 0.5555555555555556, 0.5555555555555556, 1, 0.7777777777777779, 1, 1, 0.2222222222222222, 0.2222222222222222, 0.1111111111111111, 1, 1, 0.7777777777777779, 0.8888888888888891, 1, 0.1111111111111111, 0.4444444444444444, 0.7777777777777779, 0.3333333333333333, 0.8888888888888891, 1, 0, 1, 0.5555555555555556, 1, 0.1111111111111111, 0.4444444444444444, 1, 0.5555555555555556, 0.2222222222222222, 1, 0.1111111111111111, 1, 0.4444444444444444, 0.6666666666666667, 1, 0.4444444444444444, 0.8888888888888891, 0.5555555555555556, 1, 1, 1, 1, 0.7777777777777779, 1, 0.6666666666666667, 0.8888888888888891, 0.6666666666666667, 1, 1, 0.5555555555555556, 0.7777777777777779, 0.8888888888888891, 1, 1, 0.6666666666666667, 0.6666666666666667, 0.6666666666666667, 1, 0.7777777777777779, 1, 1, 0.2222222222222222]
    # return humaneval_scores

    # mbpp_scores = [0.4444444444444444, 1.0, 1.0, 0.3333333333333333, 0.3333333333333333, 1.0, 1.0, 1.0, 0.4444444444444444, 0.8888888888888891, 1.0, 1.0, 0.6666666666666667, 0.8888888888888891, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.5555555555555556, 0.6666666666666667, 1.0, 1.0, 0.8888888888888891, 1.0, 0.1111111111111111, 1.0, 0.8888888888888891, 1.0, 0.7777777777777779, 0.4444444444444444, 1.0, 1.0, 1.0, 1.0, 1.0, 0.7777777777777779, 1.0, 0.0, 1.0, 1.0, 0.4444444444444444, 0.1111111111111111, 0.8888888888888891, 0.6666666666666667, 1.0, 1.0, 1.0, 0.8888888888888891, 1.0, 0.8888888888888891, 1.0, 1.0, 0.1111111111111111, 0.7777777777777779, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.7777777777777779, 0.6666666666666667, 1.0, 0.8888888888888891, 0.2222222222222222, 1.0, 1.0, 0.0, 0.8888888888888891, 1.0, 0.8888888888888891, 1.0, 0.6666666666666667, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.8888888888888891, 1.0, 1.0, 0.7777777777777779, 0.2222222222222222, 1.0, 0.6666666666666667, 0.8888888888888891, 1.0, 1.0, 1.0, 0.0, 1.0, 1.0, 0.3333333333333333, 1.0, 0.2222222222222222, 0.5555555555555556, 0.8888888888888891, 1.0, 1.0, 0.8888888888888891, 1.0, 1.0, 1.0, 0.4444444444444444, 0.4444444444444444, 0.7777777777777779, 0.3333333333333333, 1.0, 0.2222222222222222, 1.0, 1.0, 0.2222222222222222, 0.8888888888888891, 1.0, 1.0, 1.0, 0.3333333333333333, 0.4444444444444444, 0.6666666666666667, 1.0, 0.6666666666666667, 0.1111111111111111, 0.8888888888888891, 1.0, 1.0, 1.0, 1.0, 1.0, 0.8888888888888891, 0.0, 0.1111111111111111, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.0, 0.7777777777777779, 1.0, 1.0, 1.0, 0.7777777777777779, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.8888888888888891, 1.0, 0.6666666666666667, 1.0, 0.2222222222222222, 0.5555555555555556, 0.1111111111111111, 0.1111111111111111, 0.5555555555555556, 1.0, 0.6666666666666667, 1.0, 0.4444444444444444, 0.8888888888888891, 1.0, 0.7777777777777779, 0.4444444444444444, 0.4444444444444444, 1.0, 1.0, 1.0, 0.6666666666666667, 1.0, 1.0, 1.0, 0.6666666666666667, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.7777777777777779, 1.0, 0.4444444444444444, 1.0, 0.8888888888888891, 0.0, 1.0, 0.3333333333333333, 1.0, 0.3333333333333333, 1.0, 0.8888888888888891, 1.0, 1.0, 1.0, 1.0, 0.5555555555555556, 1.0, 1.0, 1.0, 1.0, 1.0, 0.8888888888888891, 0.6666666666666667, 0.7777777777777779, 0.8888888888888891, 0.3333333333333333, 0.3333333333333333, 0.0, 1.0, 0.2222222222222222, 0.8888888888888891, 1.0, 1.0, 0.3333333333333333, 1.0, 1.0, 0.6666666666666667, 1.0, 0.7777777777777779, 0.8888888888888891, 1.0, 1.0, 0.5555555555555556, 1.0, 1.0, 0.7777777777777779, 1.0, 1.0, 1.0, 1.0, 0.2222222222222222, 1.0, 0.6666666666666667, 1.0, 1.0, 0.7777777777777779, 1.0, 0.8888888888888891, 0.8888888888888891, 0.2222222222222222, 1.0, 1.0, 1.0, 1.0, 1.0, 0.1111111111111111, 1.0, 1.0, 1.0, 0.8888888888888891, 1.0, 1.0, 1.0, 1.0, 1.0, 0.6666666666666667, 1.0, 1.0, 0.7777777777777779, 1.0, 0.7777777777777779, 1.0, 0.7777777777777779, 0.2222222222222222, 1.0, 1.0, 1.0, 1.0, 1.0, 0.8888888888888891, 1.0, 0.8888888888888891, 1.0, 0.0, 0.6666666666666667, 0.7777777777777779, 0.5555555555555556, 0.3333333333333333, 0.6666666666666667, 1.0, 1.0, 1.0, 0.7777777777777779, 1.0, 0.5555555555555556, 0.8888888888888891, 1.0, 1.0, 1.0, 0.8888888888888891, 1.0, 0.5555555555555556, 1.0, 0.8888888888888891, 1.0, 1.0, 0.1111111111111111, 0.6666666666666667, 0.2222222222222222, 1.0, 0.7777777777777779, 1.0, 1.0, 1.0, 0.8888888888888891, 0.1111111111111111, 0.8888888888888891, 0.4444444444444444, 1.0, 0.6666666666666667, 1.0, 1.0, 1.0, 1.0, 0.7777777777777779, 1.0, 0.7777777777777779, 1.0, 0.8888888888888891, 1.0, 0.8888888888888891, 0.3333333333333333, 1.0, 0.6666666666666667, 1.0, 0.7777777777777779, 1.0, 0.7777777777777779, 0.6666666666666667, 1.0, 0.8888888888888891, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.8888888888888891, 1.0, 1.0, 1.0, 0.8888888888888891, 1.0, 0.4444444444444444, 0.8888888888888891, 0.5555555555555556, 1.0, 0.2222222222222222, 1.0, 1.0, 1.0, 0.1111111111111111, 1.0, 1.0, 1.0, 0.5555555555555556, 0.6666666666666667, 1.0, 1.0, 1.0, 1.0, 1.0, 0.0, 1.0, 1.0, 0.8888888888888891, 1.0, 1.0, 0.8888888888888891, 1.0, 0.8888888888888891, 1.0, 1.0, 1.0, 1.0, 1.0, 0.3333333333333333, 0.4444444444444444, 1.0, 1.0, 0.8888888888888891, 1.0, 1.0, 1.0, 0.5555555555555556, 1.0, 0.3333333333333333, 1.0, 1.0, 0.8888888888888891, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.8888888888888891, 1.0, 0.2222222222222222, 0.3333333333333333, 0.8888888888888891, 1.0, 0.4444444444444444, 1.0, 1.0, 1.0, 0.2222222222222222, 1.0, 1.0, 1.0, 0.1111111111111111, 1.0, 1.0, 1.0, 0.8888888888888891, 1.0, 1.0, 1.0, 0.3333333333333333, 1.0, 1.0, 1.0, 1.0, 0.8888888888888891, 0.4444444444444444, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.4444444444444444, 1.0, 1.0, 0.6666666666666667, 0.3333333333333333, 0.1111111111111111, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.8888888888888891, 1.0, 0.7777777777777779, 1.0, 1.0, 1.0, 1.0, 1.0, 0.8888888888888891, 1.0, 0.8888888888888891, 0.8888888888888891, 1.0, 0.1111111111111111, 0.7777777777777779, 1.0, 0.5555555555555556, 1.0, 1.0, 1.0, 1.0, 1.0, 0.6666666666666667, 0.6666666666666667, 0.7777777777777779, 1.0, 1.0, 1.0, 0.4444444444444444, 1.0, 0.7777777777777779, 0.4444444444444444, 1.0, 0.8888888888888891, 1.0, 0.6666666666666667, 1.0, 1.0, 0.8888888888888891, 1.0, 0.4444444444444444, 0.0, 1.0, 0.8888888888888891, 1.0, 1.0, 0.8888888888888891, 0.6666666666666667, 0.7777777777777779, 0.8888888888888891, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.8888888888888891, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.7777777777777779, 1.0, 0.6666666666666667, 1.0, 0.3333333333333333, 1.0, 0.8888888888888891, 1.0, 1.0, 0.8888888888888891, 1.0, 1.0, 1.0, 0.8888888888888891, 1.0, 1.0, 1.0, 0.8888888888888891, 1.0, 1.0, 0.4444444444444444, 1.0, 1.0, 1.0, 1.0, 0.1111111111111111, 1.0, 0.4444444444444444, 1.0, 1.0, 0.8888888888888891, 0.8888888888888891, 0.8888888888888891, 1.0, 0.4444444444444444, 0.7777777777777779, 0.0, 1.0, 1.0, 1.0, 0.8888888888888891, 1.0, 0.0, 1.0, 0.3333333333333333, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.7777777777777779, 1.0, 0.0, 1.0, 1.0, 1.0, 0.8888888888888891, 1.0, 0.1111111111111111, 0.8888888888888891, 0.1111111111111111, 1.0, 1.0, 1.0, 1.0, 0.1111111111111111, 0.4444444444444444, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.8888888888888891, 1.0, 1.0, 0.0, 1.0, 0.7777777777777779, 1.0, 0.8888888888888891, 1.0, 1.0, 1.0, 1.0, 0.2222222222222222, 1.0, 0.3333333333333333, 1.0, 0.3333333333333333, 1.0, 0.4444444444444444, 1.0, 1.0, 1.0, 0.6666666666666667, 0.8888888888888891, 1.0, 0.6666666666666667, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.8888888888888891, 0.2222222222222222, 0.0, 1.0, 1.0, 0.0, 0.2222222222222222, 0.0, 1.0, 1.0, 1.0, 1.0, 0.7777777777777779, 0.3333333333333333, 1.0, 1.0, 0.6666666666666667, 1.0, 1.0, 1.0, 1.0, 1.0, 0.3333333333333333, 1.0, 1.0, 1.0, 0.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.8888888888888891, 1.0, 1.0, 1.0, 0.5555555555555556, 1.0, 0.8888888888888891, 1.0, 1.0, 0.7777777777777779, 1.0, 1.0, 0.3333333333333333, 1.0, 0.8888888888888891, 1.0, 1.0, 1.0, 1.0, 0.8888888888888891, 1.0, 1.0, 1.0, 1.0, 0.8888888888888891, 1.0, 1.0, 0.7777777777777779, 0.7777777777777779, 1.0, 1.0, 0.6666666666666667, 0.6666666666666667, 1.0, 1.0, 0.7777777777777779, 0.5555555555555556, 0.8888888888888891, 0.8888888888888891, 1.0, 1.0, 0.6666666666666667, 0.7777777777777779, 1.0, 1.0, 0.2222222222222222, 1.0, 0.8888888888888891, 1.0, 0.3333333333333333, 0.6666666666666667, 1.0, 0.7777777777777779, 0.2222222222222222, 1.0, 0.8888888888888891, 1.0, 1.0, 0.1111111111111111, 1.0, 1.0, 0.6666666666666667, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.5555555555555556, 1.0, 1.0, 1.0, 1.0, 1.0, 0.4444444444444444, 1.0, 1.0, 0.8888888888888891, 0.4444444444444444, 1.0, 1.0, 1.0, 1.0, 0.6666666666666667, 0.6666666666666667, 1.0, 0.3333333333333333, 1.0, 1.0, 1.0, 0.3333333333333333, 1.0, 0.1111111111111111, 1.0, 0.4444444444444444, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.8888888888888891, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.7777777777777779, 1.0, 1.0, 1.0, 1.0, 0.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.0, 1.0, 0.8888888888888891, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.5555555555555556, 1.0, 1.0, 1.0, 1.0, 0.3333333333333333, 1.0, 1.0, 0.1111111111111111, 0.5555555555555556, 0.6666666666666667, 1.0, 0.8888888888888891, 1.0, 0.3333333333333333, 0.6666666666666667, 1.0, 1.0, 0.1111111111111111, 1.0, 1.0, 0.7777777777777779, 1.0, 1.0, 1.0, 0.3333333333333333, 1.0, 0.4444444444444444, 1.0, 0.3333333333333333, 1.0, 0.8888888888888891, 0.8888888888888891, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.5555555555555556, 1.0, 1.0, 1.0, 1.0, 1.0, 0.5555555555555556, 0.7777777777777779, 1.0, 1.0, 1.0, 1.0, 1.0, 0.8888888888888891, 1.0, 1.0, 0.2222222222222222, 1.0, 0.7777777777777779, 1.0, 0.8888888888888891, 1.0, 0.8888888888888891, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.3333333333333333, 1.0, 1.0, 1.0, 0.3333333333333333, 0.7777777777777779, 0.1111111111111111, 0.8888888888888891, 1.0, 1.0, 0.3333333333333333, 1.0, 1.0, 0.0, 1.0, 0.6666666666666667, 1.0, 1.0, 0.1111111111111111, 1.0, 1.0, 0.6666666666666667, 1.0, 1.0, 1.0, 0.7777777777777779, 1.0, 1.0, 0.5555555555555556, 1.0, 1.0, 1.0, 0.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.6666666666666667, 1.0, 1.0, 0.2222222222222222, 0.3333333333333333, 0.5555555555555556, 0.7777777777777779, 1.0, 1.0, 0.7777777777777779, 1.0, 0.2222222222222222, 1.0, 1.0, 1.0, 0.6666666666666667, 1.0, 0.2222222222222222, 1.0, 1.0, 1.0, 1.0, 0.6666666666666667, 0.8888888888888891, 1.0, 1.0, 1.0, 0.8888888888888891, 1.0, 1.0, 0.2222222222222222, 1.0, 1.0, 1.0, 1.0, 0.7777777777777779, 0.8888888888888891, 1.0, 0.4444444444444444, 1.0, 1.0, 1.0]
    # return mbpp_scores

    with open(filepath, 'r', encoding='utf-8') as file:
        data = json.load(file)

    y_score = []

    for question_id in range(0, int(len(data)/size_per_question)):
        codes = []
        for generation_index in range(0, size_per_question):
            codes.append(data[str(question_id * size_per_question + generation_index)]["generation_code"])

        score = 0

        with ThreadPoolExecutor(max_workers=9) as executor:
            futures = []
            for i in range(1, len(codes)):
                future = executor.submit(
                    process_comparison,
                    i,
                    codes,
                    api_key,
                    base_url,
                    model
                )
                futures.append(future)

            for future in futures:
                score += future.result()

        print(f"question_id: {question_id}")
        print(f"Score: {str(score)}")
        y_score.append(min(score, 1.0))

    return y_score